<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        position: relative;
        min-height: 100vh;
        margin: 0;
      }

      /* 为 pay-success 类添加样式 */
      .wx-authorization {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
    </style>
    <script>
      window.wx_authorization_api = "https://api-test.wincare365.com"; // 微信请求api地址
    </script>
    <script>
      // 生成随机字符串
      const generateRandomString = (length) => {
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length);
          result += characters.charAt(randomIndex);
        }
        return result;
      };

      // 获取下单信息
      const fetchOpenid = async (query) => {
        const response = await fetch(
          wx_authorization_api + "/api/v1/pay/weixin/place_order",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...query,
              platform: Number(query?.platform),
              key: query?.qrcode_key,
            }),
          }
        );

        return (await response?.json());
      };

      // 轮询订单状态
      const fetchPoliing = async (query) => {
        const response = await fetch(
          wx_authorization_api +
            `/api/v1/pay/order/qrcode_key/polling?key=${String(
              query?.qrcode_key
            )}`,
          {
            method: "GET",
          }
        );
        const data = await response?.json();

        // alert(JSON.stringify(data) + `/api/v1/pay/order/qrcode_key/polling?key=${String(query?.qrcode_key)}`);

        if (data?.error === 0) {
          const status = Number(data?.data?.status); // 订单状态

          if ([2, 3, 4, 5].includes(status)) {
            const href = window.location.href;
            const url = new URL(href);

            if (status === 2) {
              window.location.href = match?.[1] + "pay-success.html";
            } else if (status === 3) {
              window.location.href = match?.[1] + "pay-error.html";
            } else if (status === 4) {
              window.location.href = match?.[1] + "pay-cancel.html";
            } else if (status === 5) {
              window.location.href = match?.[1] + "pay-timeout.html";
            }

            // 清除定时器
            if (window.wxPollingTimer) {
              clearInterval(window.wxPollingTimer);
              delete window.wxPollingTimer;
            }
          }
        }
        return;
      };

      const onBridgeReady = async (params) => {
        WeixinJSBridge.invoke(
          "getBrandWCPayRequest",
          {
            appId: params?.appid, //公众号ID，由商户传入
            timeStamp: params?.timestamp, //时间戳，自1970年以来的秒数
            nonceStr: params?.nonce_str, //随机串
            package: params?.package,
            signType: "RSA", //微信签名方式
            paySign: params?.pay_sign, // 微信签名
          },
          function (res) {
            fetchPoliing(params);

            window.wxPollingTimer = setInterval(
              () => fetchPoliing(params),
              3000
            );

            if (res.err_msg == "get_brand_wcpay_request:ok") {
              // 使用以上方式判断前端返回,微信团队郑重提示：
              //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠，商户需进一步调用后端查单确认支付结果。
            }

            if (
              [
                "get_brand_wcpay_request:cancel",
                "get_brand_wcpay_request:fail",
              ].includes(res?.err_msg)
            ) {
              const href = window.location.href;
              const url = new URL(href);

              // 清除定时器
              if (window.wxPollingTimer) {
                clearInterval(window.wxPollingTimer);
                delete window.wxPollingTimer;
              }

              window.location.href = match?.[1] + "pay-error.html";
            }
          }
        );
      };

      const iniliteFun = async () => {
        const href = window.location.href;
        const url = new URL(href);
        const regex = /^(.*\/)/;
        const match = href.match(regex);
        const allParams = JSON.parse(localStorage.getItem("pay-search-params"));
        const code = url.searchParams.get("code");
        const wx_openid = url.searchParams.get("wx_openid");
        const appid = allParams?.appid;
        const data = await fetchOpenid({
          ...allParams,
          wx_openid: wx_openid ?? "",
          code: code ?? "",
        });

        localStorage.removeItem("pay-search-params");

        if (data?.error === 0 && data?.data?.prepay_id) {
          const params = { ...allParams, ...data?.data, appid };

          if (typeof WeixinJSBridge == "undefined") {
            if (document.addEventListener) {
              document.addEventListener(
                "WeixinJSBridgeReady",
                () => onBridgeReady(params),
                false
              );
            } else if (document.attachEvent) {
              document.attachEvent("WeixinJSBridgeReady", () =>
                onBridgeReady(params)
              );
              document.attachEvent("onWeixinJSBridgeReady", () =>
                onBridgeReady(params)
              );
            }
          } else {
            onBridgeReady(params);
          }
        } else {
          if (data?.error === 210203) {
            window.location.href = match?.[1] + "pay-real-error.html";
          } else if (data?.error === 210204) {
            window.location.href = match?.[1] + "pay-underage-error.html";
          } else if (data?.error === 250001) {
            window.location.href = match?.[1] + "pay-unfinish-order-error.html";
          } 
        }
      };

      iniliteFun();
    </script>
  </head>

  <body>
    <div class="wx-authorization">订单处理中</div>
  </body>
</html>
