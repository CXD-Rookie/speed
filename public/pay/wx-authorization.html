<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>授权回调页</title>
    <script>
      window.wx_authorization_api = "https://api-test.wincare365.com"; // 微信请求api地址
    </script>
    <script>
      // 生成随机字符串
      const generateRandomString = (length) => {
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length);
          result += characters.charAt(randomIndex);
        }
        return result;
      };

      // 获取下单信息
      const fetchOpenid = async (query) => {
        const response = await fetch(
          wx_authorization_api + "/api/v1/pay/weixin/place_order",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({...query, platform: Number(query?.platform), key: query?.qrcode_key}),
          }
        );
        const data = await response?.json();

        if (data?.error === 0) {
          return data?.data || {};
        }

        return {};
      };

      // 轮询订单状态
      const fetchPoliing = async (query) => {
        const response = await fetch(
          wx_authorization_api + `/api/v1/pay/order/qrcode_key/polling?key=${String(query?.qrcode_key)}`,
          {
            method: "GET",
          }
        );
        const data = await response?.json();
        
        // alert(JSON.stringify(data) + `/api/v1/pay/order/qrcode_key/polling?key=${String(query?.qrcode_key)}`);

        if (data?.error === 0) {
          const status = Number(data?.data?.status); // 订单状态

          if ([2, 3, 4, 5].includes(status)) {
            const href = window.location.href;
            const url = new URL(href);

            if (status === 2) {
              window.location.href = url?.origin + "/h5/pay/pay-success.html";
            } else if (status === 3) {
              window.location.href = url?.origin + "/h5/pay/pay-error.html";
            } else if (status === 4) {
              window.location.href = url?.origin + "/h5/pay/pay-cancel.html";
            } else if (status === 5) {
              window.location.href = url?.origin + "/h5/pay/pay-timeout.html";
            }

            // 清除定时器
            if (window.wxPollingTimer) {
              clearInterval(window.wxPollingTimer);
              delete window.wxPollingTimer;
              // alert("清除定时器")
            }
          }
        }
        
        // 清除定时器
        // if (window.wxPollingTimer) {
        //   clearInterval(window.wxPollingTimer);
        //   delete window.wxPollingTimer;
        //   alert("清除定时器")
        // }
        return;
      };

      const onBridgeReady = async (params) => {
        WeixinJSBridge.invoke(
          "getBrandWCPayRequest",
          {
            appId: params?.appid, //公众号ID，由商户传入
            timeStamp: params?.timestamp, //时间戳，自1970年以来的秒数
            nonceStr: params?.nonce_str, //随机串
            package: params?.package,
            signType: "RSA", //微信签名方式
            paySign: params?.pay_sign, // 微信签名
          },
          function (res) {
            window.wxPollingTimer = setInterval(() => fetchPoliing(params), 3000);
            if (res.err_msg == "get_brand_wcpay_request:ok") {
              // 使用以上方式判断前端返回,微信团队郑重提示：
              //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠，商户需进一步调用后端查单确认支付结果。
            }
          }
        );
      };

      const iniliteFun = async () => {
        const href = window.location.href;
        const url = new URL(href);
        const allParams = JSON.parse(localStorage.getItem("pay-search-params"));
        const code = url.searchParams.get("code");
        const appid = allParams?.appid;
        const data = await fetchOpenid({ ...allParams, code });

        localStorage.removeItem("pay-search-params");

        if (data?.prepay_id) {
          if (typeof WeixinJSBridge == "undefined") {
            if (document.addEventListener) {
              document.addEventListener(
                "WeixinJSBridgeReady",
                () => onBridgeReady({ ...allParams, ...data, appid }),
                false
              );
            } else if (document.attachEvent) {
              document.attachEvent("WeixinJSBridgeReady", () => onBridgeReady({ ...allParams, ...data, appid }));
              document.attachEvent("onWeixinJSBridgeReady", () => onBridgeReady({ ...allParams, ...data, appid }));
            }
          } else {
            onBridgeReady({ ...allParams, ...data, appid });
          }
        }
      };

      iniliteFun();
    </script>
  </head>

  <body>
    <div class="login-container"></div>
  </body>
</html>
