<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      window.middle_wxappid = "wx203b43bc34560cf1"; // 微信appid
      window.middle_aliappid = "ali123a456b789cd0"; // 支付宝appid
    </script>
    <script>
      // 检测应用
      const detectApp = () => {
        const userAgent = navigator.userAgent.toLowerCase();

        if (userAgent.indexOf('micromessenger') !== -1) {
          return "wechat"; // 微信
        } else if (userAgent.indexOf('alipayclient')!== -1) {
          return 'alipay'; // 支付宝
        } else {
          return 'other'; // 其他
        }
      }

      const iniliteFun = () => {
        const href = window.location.href;
        const url = new URL(href);

        const searchParams = url.searchParams;
        const allParams = {};

        searchParams.forEach((value, key) => {
          allParams[key] = value;
        });

        const userAgent = detectApp();

        // 判断是微信，支付宝扫码
        if (userAgent === "wechat") {
          // 临时存储支付信息
          localStorage.setItem("pay-search-params", JSON.stringify({...allParams, appid: window.middle_wxappid}));

          // 如果进入此页面未携带 openid 参数
          if (!allParams?.wx_openid || [undefined, "undefined", "null", null, ""].includes(allParams?.wx_openid)) {
            // 成功回调地址
            // 网页授权
            // 获取 code
            const redirect_uri = encodeURIComponent(url?.origin + "/h5/pay/wx-authorization.html");
            const scope = "snsapi_base";
            const to_url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${window.middle_wxappid}&redirect_uri=${redirect_uri}&response_type=code&scope=${scope}&state=#wechat_redirect`;
            alert("无wx_openid:" + allParams?.wx_openid);
            window.location.href = to_url
          } else {
            alert("有wx_openid:" + allParams?.wx_openid);
            window.location.href = url?.origin + `/h5/pay/wx-authorization.html?wx_openid=${allParams?.wx_openid}`;
          }
        } else if (userAgent === 'alipay') {
          const redirect_uri = url?.origin + "/h5/pay/pay-error.html";
          window.location.href = redirect_uri
        } else {
          const redirect_uri = url?.origin + "/h5/pay/pay-support-system.html";
          window.location.href = redirect_uri
        }
      }
      
      iniliteFun();
    </script>
</head>
<body>
  <div class="login-container">
  </div>
</body>
</html>
