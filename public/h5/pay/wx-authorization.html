<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        position: relative;
        min-height: 100vh;
        margin: 0;
      }

      /* 为 pay-success 类添加样式 */
      .wx-authorization {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
    </style>
    <script>
      // 轮询订单状态
      const fetchPoliing = async (query) => {
        const response = await fetch(
          wx_authorization_api +
            `/api/v1/pay/order/qrcode_key/polling?key=${String(
              query?.qrcode_key
            )}`,
          {
            method: "GET",
          }
        );
        const data = await response?.json();

        if (data?.error === 0) {
          const status = Number(data?.data?.status); // 订单状态

          if ([2, 3, 4, 5].includes(status)) {
            const href = window.location.href;
            const url = new URL(href);

            let hrefMap = href.split('?')?.[0]?.split('/');

            hrefMap.pop();

            const newHrefStr = hrefMap.join('/');

            if (status === 2) {
              window.location.href = newHrefStr + "/pay-success.html";
            } else if (status === 3) {
              window.location.href = newHrefStr + "/pay-error.html";
            } else if (status === 4) {
              window.location.href = newHrefStr + "/pay-cancel.html";
            } else if (status === 5) {
              window.location.href = newHrefStr + "/pay-timeout.html";
            }

            // 清除定时器
            if (window.wxPollingTimer) {
              clearInterval(window.wxPollingTimer);
              delete window.wxPollingTimer;
            }
          }
        }
        return;
      };

      const onBridgeReady = async (params) => {
        WeixinJSBridge.invoke(
          "getBrandWCPayRequest",
          {
            appId: params?.appid, //公众号ID，由商户传入
            timeStamp: params?.timestamp, //时间戳，自1970年以来的秒数
            nonceStr: params?.nonce_str, //随机串
            package: params?.package,
            signType: "RSA", //微信签名方式
            paySign: params?.pay_sign, // 微信签名
          },
          function (res) {
            fetchPoliing(params);

            window.wxPollingTimer = setInterval(
              () => fetchPoliing(params),
              3000
            );

            if (res.err_msg == "get_brand_wcpay_request:ok") {
              // 使用以上方式判断前端返回,微信团队郑重提示：
              //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠，商户需进一步调用后端查单确认支付结果。
            }

            if (
              [
                "get_brand_wcpay_request:cancel",
                "get_brand_wcpay_request:fail",
              ].includes(res?.err_msg)
            ) {
              let href = window.location.href;
              let url = new URL(href);
              let hrefMap = href.split('?')?.[0]?.split('/');

              hrefMap.pop();

              // 清除定时器
              if (window.wxPollingTimer) {
                clearInterval(window.wxPollingTimer);
                delete window.wxPollingTimer;
              }

              window.location.href = hrefMap.join('/') +'/pay-error.html';
            }
          }
        );
      };

      const iniliteFun = async () => {
        const payState = sessionStorage.getItem("pay_state");
        const href = window.location.href;
        const pathname = window.location.pathname;
        const url = new URL(href);

        const regex = /^(.*\/)/;
        const match = href.match(regex);

        const openid = url.searchParams.get("openid");
        const prepay_id = url.searchParams.get("prepay_id");
        const pay_sign = url.searchParams.get("pay_sign");
        const timestamp = url.searchParams.get("timestamp");
        const nonce_str = url.searchParams.get("nonce_str");
        const package = url.searchParams.get("package");
        const qrcode_key = url.searchParams.get("qrcode_key");
        const appid = url.searchParams.get("appid");

        // 使用正则表达式判断路径的第一个目录是否为 'web'
        const isFirstSegmentWeb = /^\/web\//.test(pathname);

        if (
          payState &&
          ![null, "null", undefined, "undefined", "", " "].includes(payState)
        ) {
          window.location.href = match?.[1] + `${payState}.html`;
        }

        if (isFirstSegmentWeb) {
          window.wx_authorization_api = "https://api.wincare365.com";
        } else {
          window.wx_authorization_api = "https://api-test.withplay.cn";
        }

        if (
          openid &&
          prepay_id &&
          pay_sign &&
          timestamp &&
          nonce_str &&
          qrcode_key &&
          package &&
          appid
        ) {
          const params = {
            openid,
            prepay_id,
            pay_sign,
            timestamp,
            nonce_str,
            qrcode_key,
            package,
            appid,
          };

          if (typeof WeixinJSBridge == "undefined") {
            if (document.addEventListener) {
              document.addEventListener(
                "WeixinJSBridgeReady",
                () => onBridgeReady(params),
                false
              );
            } else if (document.attachEvent) {
              document.attachEvent("WeixinJSBridgeReady", () =>
                onBridgeReady(params)
              );
              document.attachEvent("onWeixinJSBridgeReady", () =>
                onBridgeReady(params)
              );
            }
          } else {
            onBridgeReady(params);
          }
        } 
        // else {
        //   window.location.href = match?.[1] + "pay-error.html";
        // }
      };

      iniliteFun();
    </script>
  </head>

  <body>
    <div class="wx-authorization">订单处理中</div>
  </body>
</html>
