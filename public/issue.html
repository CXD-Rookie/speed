<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 引入 layui.css -->
    <link href="//unpkg.com/layui@2.9.9/dist/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <style>
        .type-buttons, .matter-description {
            margin-top: 5.6vh;
            margin-left: 1.6vw;
        }

        .matter-description .matter-text,
        .type-buttons .matter-type {
            font-size: 2vw;
            color: #999999;
            line-height: 4vh;
        }

        .matter-description .matter-text span,
        .type-buttons .matter-type span {
            color: #F86C34;
        }

        .type-btn {
            width: 12.5vw;
            height: 6.4vh;
            font-size: 1.8vw;
            font-weight: Regular;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.10);
            text-align: center;
            line-height: 6.4vh;
            border-radius: 1vh;
            border: 1px solid transparent;
            margin: 1.6vh 1.5vw 0 0;
            cursor: pointer;
            position: relative;
            /* 添加默认边框 */
        }

        .type-btn:nth-of-type(1) {
            margin-left: 1.05vw;
        }

        .type-btn.selected {
            border-color: #F86C34;
            /* 选中状态下边框颜色 */
            color: #F86C34;
            /* 选中状态下文字颜色 */
        }

        .type-btn.selected::before {
            content: "\2713";
            /* 对号的 Unicode */
            display: inline-block;
            position: absolute;
            top: 0;
            right: 0.6vw;
            width: 1vw;
            height: 1.5vh;
            color: #fff;
            line-height: 3vh;
            text-align: center;
            z-index: 2;
        }

        .type-btn.selected::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0px;
            right: 0px;
            border-left: 1.8vw solid transparent;
            border-bottom: 1.8vw solid transparent;
            border-right: 1.8vw solid #F86C34;
            border-top: 1.8vw solid #F86C34;
        }

        .description-input-box {
            color: #fff;
            margin: 1.6vh 1.05vw 0 1.05vw;
        }

        .description {
            width: 90vw;
            min-height: 8vh;
            font-size: 1.8vw;
            color: #fff;
            background: rgba(255, 255, 255, 0.10);
            padding: 1.6vh 1.8vw;
            border: none;
            border-top-left-radius: 1vh;
            border-top-right-radius: 1vh;
            resize: none;
            vertical-align: middle;
        }

        .description::-webkit-scrollbar {
            width: 0px;
        }

        .description::placeholder {
            font-weight: Regular;
            font-size: 1.8vw;
            color: #999999;
            margin: 1.6vh 1.8vw;
        }

        .description-input-num {
            width: 90vw;
            font-size: 1.8vw;
            color: #999;
            background: rgba(255, 255, 255, 0.10);
            text-align: right;
            padding: 1.6vh 1.8vw;
            border-bottom-left-radius: 1vh;
            border-bottom-right-radius: 1vh;
            vertical-align: middle;
        }

        .layui-upload {
            display: flex;
            margin-left: 1.05vw;
            margin-top: 3.2vh;
        }

        .layui-elem-quote {
            width: 7.5vw;
            height: 7.5vw;
            border: none;
        }

        .fa-plus {
            width: 7.5vw;
            height: 7.5vw;
            font-size: 3vw;
            color: #fff;
            background-color: #52525c;
            border: 0.5px dashed #fff;
            text-align: center;
            line-height: 7.5vw;
            cursor: pointer;
        }

        .img-container {
            position: relative;
            margin-right: 2vw;
        }

        .fa-times-circle:before {
            content: "\00D7";
            position: absolute;
            width: 2.4vw;
            height: 2.4vw;
            font-size: 2vw;
            top: -1.2vw;
            right: -1.2vw;
            text-align: center;
            line-height: 2.4vw;
            background-color: #F86C34;
            border-radius: 50%;
            color: #fff;
        }

        .image-upload {
            position: relative;
        }

        .layui-elem-quote {
            width: auto;
            border: none;
            padding: 0;
            margin-left: 1.3vw;
        }

        .layui-upload-list {
            display: flex;
            margin: 0;
        }

        #file-input {
            display: none;
        }

        #file-input+label {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 6vw;
            height: 6vw;
            background-color: #ccc;
            cursor: pointer;
        }

        .preview {
            margin-top: 1.5vh;
        }

        .preview img {
            width: 15vw;
            height: 15vw;
            margin-right: 2vw;
            display: inline-block;
        }

        .contact {
            font-size: 2.1vw;
            color: #999;
            margin: 5.6vh 1.35vw;
            padding-left: 1.05vw;
        }

        .contact-input-box {
            display: flex;
            align-items: flex-end;
        }

        .contact .contact-input {
            width: 54vw;
            height: 4vh;
            font-size: 1.8vw;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            border-top-left-radius: 1vh;
            border-bottom-left-radius: 1vh;
            border: none;
            padding: 1.2vh 0.6vw 1.2vh 2.4vw;
            margin-top: 1.4vh;
        }

        .contact .contact-input::placeholder {
            font-weight: Regular;
            font-size: 1.8vw;
        }

        .contact-input-num {
            display: inline-block;
            width: 7.5vw;
            height: 6.4vh;
            background: rgba(255, 255, 255, 0.10);
            border-top-right-radius: 1vh;
            border-bottom-right-radius: 1vh;
            text-align: center;
            line-height: 6.4vh;
        }

        .submit-btn {
            display: block;
            width: 24.75vw;
            height: 8.8vh;
            font-size: 1.8vw;
            color: #999;
            background-color: #52525c;
            border: none;
            outline: none;
            border-radius: 4.4vh;
            text-align: center;
            line-height: 8.8vh;
            cursor: pointer;
            margin: 0 auto;
        }

        .submit-btn:hover {
            color: #fff;
            background-color: #F86C34;
        }

        .popup-success {
            width: 48vw;
            height: 26vh;
            font-size: 1.95vw;
            color: #fff;
            background: #3e3e4a;
            border-radius: 2vh;
            box-shadow: 0px 0px 6vh 0px rgba(0, 0, 0, 0.50);
            padding: 2vh 1.8vw;
            text-align: center;
            position: fixed;
            margin: auto;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .popup-success img {
            margin-left: 45vw;
        }

        .sucess-text {
            margin: 6.4vh 0 5.6vh 0;
        }

        .sucess-btn {
            width: 14.4vw;
            height: 6.4vh;
            font-size: 1.4vw;
            color: #fff;
            background: rgba(255, 255, 255, 0.10);
            border-radius: 3.2vh;
            border: none;
            outline: none;
            cursor: pointer;
        }
    </style>
    <title>问题反馈</title>
</head>

<body>
    <div class="overlay">
        <div class="feedback-popup">
            <div class="type-buttons" id="btnAll">
                <div class="matter-type">
                    <span>*</span>
                    问题类型
                </div>
            </div>
            <div class="matter-description">
                <div class="matter-text">
                    <span>*</span>
                    问题描述
                </div>
                <div class="description-input-box">
                    <textarea id="description" class="description"
                        placeholder="请描述您所遇到的问题，上传图片格式支持JPG/PNG/JPEG，大小<5MB"></textarea>
                    <div id="description-input-num" class="description-input-num">
                        0/500
                    </div>
                </div>
            </div>
            <div class="layui-upload">
                <blockquote class="layui-elem-quote layui-quote-nm">
                    <div class="layui-upload-list" id="upload-demo-preview"></div>
                </blockquote>
                <label for="file-input" id="ID-upload-demo-btn-2"><i class="fas fa-plus"></i></label>
            </div>
            <div class="contact">
                <div>联系方式（选填）</div>
                <div class="contact-input-box">
                    <input id="contact-input" class="contact-input" type="text" placeholder="手机/邮箱/微信"></input>
                    <div id="contact-input-num" class="contact-input-num">
                        0/50
                    </div>
                </div>
            </div>
            <button class="submit-btn">提交</button>
            <div id="popup-success" class="popup-success" style="display: none;">
                <img class="popup-success-img" src="assets/cloture_write.svg" width="12" height="12" alt="" />
                <div class="sucess-text">您的问题已反馈</div>
                <button class="sucess-btn">确定</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="//unpkg.com/layui@2.9.9/dist/layui.js"></script>

    <script>
        $(document).ready(function () {
            // 在页面加载时设置全局的 AJAX 默认选项
            $.ajaxSetup({
                headers: {
                    'client_token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRfaWQiOiJyZGZnc2RmLWFtZmhmdC1tZm1lcnRhYS1hZGZhZGZnZHMtZ2Rmc2dmIiwiY2xpZW50X2lwIjoiMTI3LjAuMC4xIiwiZXhwIjoxNzE4NDQzMjE1fQ.Ww-OhE8HAxjrMIjPmwA5UEXBt_wjEARwA1aNQ0UEG58',
                    'client_id': 'rdfgsdf-amfhft-mfmertaa-adfadfgds-gdfsgf',
                    'user_token': "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdmF0YXIiOiIiLCJjbGllbnRfaWQiOiJyZGZnc2RmLWFtZmhmdC1tZm1lcnRhYS1hZGZhZGZnZHMtZ2Rmc2dmIiwiY3JlYXRlX3RpbWUiOjE3MTU1ODg2NTUsImV4cCI6MTcxODQ0MzQzNywiaWQiOiI2NjQxY2UyZjFkY2EyOGExNjdmN2U5M2YiLCJsb2dpbl9pcCI6IjEyNy4wLjAuMSIsIm5pY2tuYW1lIjoi5bm75oOz5bel56iL5aWH5omNIiwicGhvbmUiOiI4ZjBmM2M1YTdmMTJmYmE2MTMxMWE4ZDBmNDBjNjY3NSIsInBsYXRmb3JtIjoiV2luZG93cyIsInVwZGF0ZV90aW1lIjoxNzE1ODUxNDM3fQ.OMLHSklc9NVwW0FdM9LfR4yMACn_6oGvRWSdTHLT4hc"
                }
            });

            init()
            // 打开反馈弹窗
            $('.open-popup-btn').click(function () {
                $('.overlay').fadeIn();
            });

            // 关闭反馈弹窗
            $('.close-popup-btn').click(function () {
                $('.overlay').fadeOut();
            });

            $('#description').on('input', function () {
                var maxLength = 500;
                var currentLength = $(this).val().length;
                var wordsRemaining = maxLength - currentLength;

                // 如果输入超过500字，截取字符串至500字
                if (currentLength > maxLength) {
                    $(this).val($(this).val().substring(0, maxLength));
                }
            });
            $('#contact-input').on('input', function () {
                var maxLength = 50;
                var currentLength = $(this).val().length;
                var wordsRemaining = maxLength - currentLength;

                // 如果输入超过500字，截取字符串至500字
                if (currentLength > maxLength) {
                    $(this).val($(this).val().substring(0, maxLength));
                }
            });

            // 图片预览
            $('#file-input').change(function () {
                $('.preview').empty();
                var files = this.files;
                for (var i = 0; i < files.length; i++) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('.preview').append('<img src="' + e.target.result +
                            '"><i class="fas fa-times"></i>');
                    }
                    reader.readAsDataURL(files[i]);
                }
            });

            // 关闭预览图片
            $('.preview').on('click', 'i.fa-times', function () {
                $(this).prev('img').remove();
                $(this).remove();
            });

            //图片上传
            layui.use(function () {
                var upload = layui.upload;
                var layer = layui.layer;
                var element = layui.element;
                var $ = layui.$;

                // 定义最大上传数量
                var maxImages = 3;
                // 多图片上传
                upload.render({
                    elem: '#ID-upload-demo-btn-2',
                    url: 'https://tc-js.yuwenlong.cn/api/v1/feedback_upload_image?platform=3', // 实际使用时改成您自己的上传接口即可。
                    multiple: false,
                    number: 1,
                    acceptMime: 'image/jpeg, image/png',
                    before: function (obj) {
                        var $previewImages = $('#upload-demo-preview .img-container');
                        if ($previewImages.length >= maxImages) {
                            layer.msg('最多只能上传 ' + maxImages + ' 张图片');
                            return false; // 阻止上传
                        }
                        // 预读本地文件示例，不支持ie8
                        obj.preview(function (index, file, result) {
                            var $imgContainer = $(
                                '<div class="img-container"></div>');
                            var $img = $('<img src="' + result + '" alt="' + file
                                .name +
                                '" style="width: 7.5vw; height: 7.5vw;border-radius: 5px;">'
                                );
                            var $deleteIcon = $(
                                '<i class="fas fa-times-circle delete-icon"></i>'
                                );
                            $imgContainer.append($img).append($deleteIcon);
                            $('#upload-demo-preview').append($imgContainer);
                        });
                    },
                    done: function (res) {
                        // 上传完毕
                        if (res.error === 0) {
                            var imageUrl = res.data.url;
                            var $previewImages = $('#upload-demo-preview img');
                            var index = $previewImages.length - 1; // 获取最后一张图片的索引
                            var $lastPreviewImage = $previewImages.eq(index); // 获取最后一张预览图片
                            $lastPreviewImage.attr('src', imageUrl); // 替换最后一张预览图片的 src 属性
                            console.log('Upload successful:', imageUrl);
                        } else {
                            console.error('Upload failed:', res.message);
                        }
                    }
                });
                // 点击删除图标删除预览图片
                $('#upload-demo-preview').on('click', '.delete-icon', function () {
                    $(this).parent('.img-container').remove();
                });
            });

            $("#contact-input").on("input", function (e) {
                var inputValue = $(this).val();

                inputValue = inputValue.slice(0, 50);

                var value_len = inputValue.length;

                $('#contact-input-num').text(value_len + "/50");
            })

            $("#description").on("input", function (e) {
                var inputValue = $(this).val();

                inputValue = inputValue.slice(0, 500);

                var value_len = inputValue.length;

                $('#description-input-num').text(value_len + "/500");
            })

            // 提交表单
            $('.submit-btn').click(function () {
                var moda1Type = $('#popup-success');

                var type = $('.type-btn.selected').data('type');
                var description = $('.description').val();
                var images = [];
                if (type == undefined || type == '' || type == null || description == 'undefined' ||
                    description == '' || description == null) {
                    layer.msg('请选择问题类型或者填写问题描述');
                    return
                }
                // 获取图片 URL
                $('#upload-demo-preview img').each(function () {
                    images.push($(this).attr('src'));
                });

                // 调用提交反馈的接口
                $.ajax({
                    url: 'https://tc-js.yuwenlong.cn/api/v1/feedback?platform=3',
                    type: 'POST',
                    data: JSON.stringify({
                        feedback_type: type,
                        content: description,
                        image_url: images,
                        contact_way: '' // 你的联系方式
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        // 处理提交成功后的逻辑
                        console.log('Feedback submitted successfully.');

                        $('#popup-success').show();
                        $('.sucess-btn').click(function () {
                            $('#popup-success').hide();
                            // 清空表单，关闭弹窗等
                            $('.description').val('');
                            $('#upload-demo-preview').empty();
                            $('.type-btn').removeClass('selected');
                            // $('.overlay').fadeOut();

                            const message = {
                                type: "GREETING",
                                text: "关闭问题反馈",
                                timestamp: Date.now()
                            };

                            window.parent.postMessage(message, "http://192.168.111.114:3001");
                        })
                        $('.popup-success-img').click(function () {
                            $('#popup-success').hide();
                            // 清空表单，关闭弹窗等
                            $('.description').val('');
                            $('#upload-demo-preview').empty();
                            $('.type-btn').removeClass('selected');
                            // $('.overlay').fadeOut();

                            const message = {
                                type: "GREETING",
                                text: "关闭问题反馈",
                                timestamp: Date.now()
                            };

                            window.parent.postMessage(message, "http://192.168.111.114:3001");
                        })

                    },
                    error: function (error) {
                        // 处理提交失败后的逻辑
                        console.error('Failed to submit feedback:', error);
                    }
                });
            });

            function init() {
                // 调用提交反馈的接口
                $.ajax({
                    url: 'https://rm-mga-dev.yuwenlong.cn/api/v1/feedback_type?platform=3',
                    type: 'get',
                    contentType: 'application/json',
                    success: function (response) {

                        var jsonData = response.data.types;
                        // 遍历JSON数据
                        $.each(jsonData, function (index, item) {

                            var $tab = $('#btnAll');

                            $tab.append('<button class="type-btn" data-type="' + item.id +
                                '">' + item.value + '</button>');


                        });
                        $('.type-btn').click(function () {
                            $('.type-btn').removeClass('selected');
                            $(this).addClass('selected');

                            var selectedType = $(this).data('type');
                            console.log(selectedType);
                        });
                    },
                    error: function (error) {
                        // 处理提交失败后的逻辑
                        console.error('Failed to submit feedback:', error);
                    }
                });
            }
        });
    </script>

</body>

</html>